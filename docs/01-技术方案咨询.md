# PostgreSQL 到 OceanBase 迁移技术方案（简化版）

## 前提条件

本方案基于以下约束条件制定：
1. **忽略特殊类型处理**：JSON/JSONB 类型和数组类型字段在迁移时将被忽略
2. **OceanBase 使用 MySQL 租户模式**
3. **迁移策略**：全量迁移 + 停机迁移
4. **迁移模式**：使用自定义脚本或工具，不依赖 OMS 数据传输服务

---

## 一、迁移前准备工作

### 1.1 环境评估

#### 源端 PostgreSQL 环境检查
- **版本检查**：支持 PostgreSQL 11.x 及以上版本
- **数据库大小检查**：
  ```sql
  SELECT pg_size_pretty(pg_database_size('your_database'));
  ```

#### 数据库兼容性评估
- 检查是否使用以下不支持的特性：
  - 视图（Views）
  - 分区表（Partitioned Tables）
  - Unlogged 表
  - 临时表（Temporary Tables）
  - 外键（Foreign Keys）
  - 检查约束（Check Constraints）

#### 数据量评估
- 统计数据库总大小
- 识别大表（超过 1 亿行或 10GB）
- 评估预计迁移时间（参考：每秒约 1-5 万条记录）

### 1.2 数据类型映射分析

#### PostgreSQL 到 OceanBase MySQL 租户类型映射

| PostgreSQL 类型 | OceanBase MySQL 类型 | 注意事项 |
|----------------|---------------------|----------|
| SMALLINT | SMALLINT | 2字节整数 |
| INTEGER | INT | 4字节整数 |
| BIGINT | BIGINT | 8字节整数 |
| NUMERIC(p,s) | DECIMAL(p,s) | 需保持精度一致 |
| REAL | FLOAT | 单精度浮点 |
| DOUBLE PRECISION | DOUBLE | 双精度浮点 |
| TEXT | TEXT | 大文本数据 |
| VARCHAR(n) | VARCHAR(n) | 字符串类型 |
| CHAR(n) | CHAR(n) | 定长字符串 |
| BYTEA | VARBINARY/BLOB | 二进制数据 |
| DATE | DATE | 日期类型 |
| TIMESTAMP | TIMESTAMP | 时间戳 |
| TIMESTAMPTZ | TIMESTAMP | 时间戳（不保留时区）|
| BOOLEAN | TINYINT(1) | 0=FALSE, 1=TRUE |
| JSON/JSONB | 忽略 | 不迁移 |
| ARRAY | 忽略 | 不迁移 |
| UUID | VARCHAR(36) | UUID 存储 |
| ENUM | VARCHAR(n) | 枚举类型 |

**注意事项**：
- JSON/JSONB 类型和数组类型字段在表结构迁移时将被自动忽略
- TIMESTAMP WITH TIME ZONE 会转换为 TIMESTAMP，时区信息会丢失
- 布尔类型会转换为 TINYINT(1)，应用代码需要适配

### 1.3 表名和字段名规范

**命名规范要求**：
- 仅支持 ASCII 码字符
- 不允许包含特殊字符：换行、空格、.|"'`()=;/&\\
- OceanBase MySQL 租户默认小写敏感（lower_case_table_names = 1）

### 1.4 权限准备

#### PostgreSQL 源端用户权限
```sql
-- 创建迁移专用用户
CREATE USER migration_user WITH PASSWORD 'password';

-- 授予必要权限
GRANT CONNECT ON DATABASE your_database TO migration_user;
GRANT USAGE ON SCHEMA public TO migration_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO migration_user;
```

#### OceanBase MySQL 租户目标端用户权限
```sql
-- 创建迁移专用用户
CREATE USER 'migration_user'@'%' IDENTIFIED BY 'password';

-- 授予必要权限
GRANT ALL PRIVILEGES ON your_database.* TO 'migration_user'@'%';
FLUSH PRIVILEGES;
```

### 1.5 存储空间评估

**OceanBase 需要额外空间**：
- 数据存储：源端数据量的 1.5-2 倍
- 索引空间：考虑重建索引的临时空间
- 备份空间：预留迁移备份空间

---

## 二、迁移策略选择

### 2.1 全量迁移（本方案采用的策略）

**流程**：
1. 停止应用写入
2. 全量迁移表结构
3. 全量迁移数据
4. 验证数据一致性
5. 切换应用到 OceanBase
6. 启动业务

**优点**：
- 实施简单、风险低
- 无需复杂的增量同步配置
- 数据一致性易于验证

**缺点**：
- 业务中断时间较长
- 需要停机窗口

**适用**：
- 数据量 < 100GB
- 可接受停机时间 2-6 小时
- 对数据一致性要求极高

### 2.2 迁移模式选择

#### 自定义脚本开发（本方案采用的模式）
**优点**：
- 完全可控，可定制化
- 不依赖云服务
- 成本低
- 可灵活处理特殊字段（忽略 JSON/JSONB 和数组类型）

**缺点**：
- 需要开发工作
- 需要处理各种边界情况
- 维护成本较高

#### pg_dump + obloader 工具
**适用场景**：
- 小到中等规模数据库（< 50GB）
- 需要快速迁移

**优点**：
- 工具成熟，稳定
- 操作相对简单

**缺点**：
- 不支持过滤特殊字段
- 需要手动处理类型映射

---

## 三、迁移工具推荐

### 3.1 官方工具对比

| 工具 | 用途 | 优点 | 缺点 |
|------|------|------|------|
| **OMS 数据传输** | 在线迁移 | 自动化程度高、支持增量 | 仅阿里云、性能有限 |
| **obdumper** | 数据导出 | 高性能、支持多种格式 | 仅支持 OceanBase |
| **obloader** | 数据导入 | 高性能、支持批量 | 仅支持 OceanBase |

### 3.2 OMS 数据传输配置步骤

#### 步骤1：创建数据迁移任务
1. 登录阿里云控制台
2. 进入数据传输服务
3. 点击"创建迁移任务"
4. 选择源端：RDS PostgreSQL
5. 选择目标端：OceanBase Oracle 租户

#### 步骤2：配置源端连接
- 数据源名称：自定义
- 实例类型：RDS PostgreSQL
- 实例ID：选择 PostgreSQL 实例
- 数据库账号：使用准备好的迁移用户
- 数据库密码：输入密码

#### 步骤3：配置目标端连接
- 数据源名称：自定义
- 实例类型：OceanBase
- 租户类型：Oracle 租户
- 集群地址：输入 OceanBase 连接地址
- 租户名称：输入租户名
- 数据库账号：使用准备好的迁移用户
- 数据库密码：输入密码

#### 步骤4：选择迁移类型
- **结构迁移**：迁移表结构（自动处理类型转换）
- **全量迁移**：迁移历史数据
- **增量同步**：实时同步变更（需配置 wal_level = logical）

#### 步骤5：选择迁移对象
- 方式1：指定对象 - 选择特定的表
- 方式2：匹配规则 - 使用正则表达式匹配

**注意事项**：
- 增量同步时，选择的表必须满足 REPLICA IDENTITY 要求
- 不支持迁移的表会被自动排除

#### 步骤6：预检查
系统会自动进行以下检查：
- 源端和目标端连接性
- 源端 wal_level 配置
- 表级 REPLICA IDENTITY
- 目标端存储空间
- 字符集兼容性

#### 步骤7：启动迁移
- 结构迁移：首先执行
- 全量迁移：结构迁移完成后执行
- 增量同步：全量迁移的同时启动

### 3.3 obdumper/obloader 使用示例

#### 大表旁路导出（PostgreSQL）
```bash
# 使用 pg_dump 导出数据
pg_dump -h postgres_host -p 5432 -U migration_user \
  -d your_database -t large_table \
  -F c -f /backup/large_table.dump
```

#### 大表旁路导入（OceanBase）
```bash
# 使用 obloader 导入
obloader -h oceanbase_host -P 2881 \
  -u migration_user@tenant#cluster -p password \
  -D your_database -t large_table \
  --table 'large_table' \
  --file /backup/large_table.dump \
  --thread 8
```

---

## 四、迁移步骤详解

### 4.1 完整迁移流程图

```
准备阶段
├── 1. 环境评估和检查
├── 2. 数据类型映射分析
├── 3. 创建迁移用户
└── 4. 配置 PostgreSQL wal_level
    ↓
迁移阶段
├── 5. 创建 OMS 迁移任务
├── 6. 配置源端和目标端
├── 7. 执行结构迁移
├── 8. 执行全量迁移
└── 9. 启动增量同步
    ↓
验证阶段
├── 10. 数据一致性校验
├── 11. 性能测试
└── 12. 应用功能测试
    ↓
切换阶段
├── 13. 选择切换时间窗口
├── 14. 停止应用写入
├── 15. 等待增量同步追平
├── 16. 切换应用到 OceanBase
└── 17. 验证业务正常运行
    ↓
收尾阶段
├── 18. 监控运行状态
├── 19. 性能优化调整
└── 20. 清理源端资源
```

### 4.2 详细操作步骤

#### 步骤1：环境评估和检查

**PostgreSQL 端**：
```sql
-- 检查版本
SELECT version();

-- 检查数据库大小
SELECT pg_size_pretty(pg_database_size('your_database'));

-- 检查表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 检查不支持的表类型
SELECT tablename FROM pg_tables 
WHERE tablename IN (
    SELECT inhrelid::regclass 
    FROM pg_inherits 
    WHERE inhparent = ANY(
        SELECT oid FROM pg_class WHERE relkind = 'r'
    )
); -- 分区表

-- 检查视图
SELECT schemaname, viewname FROM pg_views;

-- 检查外部表
SELECT schemaname, tablename FROM pg_tables WHERE tablename LIKE '%_%';
```

**OceanBase 端**：
```sql
-- 检查租户容量
SELECT * FROM oceanbase.DBA_OB_TENANTS;

-- 检查存储空间
SELECT * FROM oceanbase.DBA_OB_TABLEGROUPS;
```

#### 步骤2：数据类型映射分析

创建类型映射表：
```sql
-- PostgreSQL 端执行，生成类型映射报告
SELECT 
    table_name,
    column_name,
    data_type,
    character_maximum_length,
    numeric_precision,
    numeric_scale
FROM information_schema.columns
WHERE table_schema = 'public'
ORDER BY table_name, ordinal_position;
```

#### 步骤3：创建迁移用户

已在 1.4 中详细说明。

#### 步骤4：配置 PostgreSQL wal_level

```sql
-- 检查当前设置
SHOW wal_level;

-- 如需修改
ALTER SYSTEM SET wal_level = 'logical';

-- 重载配置
SELECT pg_reload_conf();

-- 确认修改
SHOW wal_level;
```

#### 步骤5-9：OMS 迁移任务配置

已在 3.2 中详细说明。

#### 步骤10：数据一致性校验

**记录数校验**：
```sql
-- PostgreSQL
SELECT COUNT(*) FROM your_table;

-- OceanBase
SELECT COUNT(*) FROM your_table;
```

**抽样校验**：
```sql
-- 对比前 1000 条记录
-- PostgreSQL
SELECT * FROM your_table ORDER BY id LIMIT 1000;

-- OceanBase
SELECT * FROM your_table ORDER BY id LIMIT 1000;
```

#### 步骤13-17：切换操作

**切换检查清单**：
- [ ] 增量同步延迟 < 1秒
- [ ] 数据一致性校验通过
- [ ] 应用连接配置已更新
- [ ] 回滚方案已准备
- [ ] 通知相关方

**切换命令示例**：
```bash
# 停止应用服务
systemctl stop your_app

# 等待增量同步追平（监控 OMS 控制台）
# ...

# 更新应用配置（指向 OceanBase）
# ...

# 启动应用服务
systemctl start your_app

# 验证应用
curl http://localhost:8080/health
```

---

## 五、性能优化建议

### 5.1 OMS 参数优化

根据实际案例，可进行以下优化：

#### 第一次优化：增加并发
```
limitator.platform.threads.number: 32 → 64
limitator.select.batch.max: 1200 → 2400
limitator.image.insert.batch.max: 200 → 400
limitator.datasource.image.ob10freecpu.min: 0
limitator.datasource.connections.max: 50 → 200
```

#### JVM 内存优化
```
-server 
-Xms16g -Xmx16g -Xmn8g -Xss256k 
→ 
-server 
-Xms64g -Xmx64g -Xmn48g -Xss256k
```

### 5.2 OceanBase 优化参数

```sql
-- 开启日志压缩
ALTER SYSTEM SET clog_transport_compress_all = 'true';
ALTER SYSTEM SET clog_transport_compress_func = 'zlib_1.0';
ALTER SYSTEM SET enable_clog_persistence_compress = 'true';

-- 加大转储线程
ALTER SYSTEM SET _mini_merge_concurrency = 32;
ALTER SYSTEM SET minor_merge_concurrency = 32;

-- 加大合并线程数
ALTER SYSTEM SET merge_thread_count = 64;

-- 写入限流
ALTER SYSTEM SET writing_throttling_trigger_percentage = 80;

-- 降低转储内存阈值
ALTER SYSTEM SET freeze_trigger_percentage = 30;

-- Leader 打散到多个 Zone
ALTER tenant your_tenant_name SET primary_zone = 'RANDOM';
```

### 5.3 大表迁移优化

**分区表改为非分区表**：
- 单表数据 < 10亿行或 < 2000GB 可不考虑分区
- 分区表会导致分布式执行计划，效率较差

**临时删除二级索引**：
```sql
-- 查看所有索引
SELECT index_name, table_name FROM user_indexes;

-- 备份索引定义
SELECT DBMS_METADATA.GET_DDL('INDEX', index_name) FROM user_indexes;

-- 删除二级索引
DROP INDEX index_name;

-- 全量迁移完成后重建索引
CREATE INDEX index_name ON table_name(column_name);
```

**使用旁路导入**：
```bash
# OceanBase 旁路导入
obloader -h host -P 2881 -u user@tenant#cluster -p password \
  -D database -t table_name \
  --file /path/to/dump \
  --thread 16 \
  --batch-size 5000
```

---

## 六、风险和注意事项

### 6.1 数据丢失风险

**风险点**：
- 增量同步中断导致数据不一致
- 切换时未等待增量追平
- 大表迁移失败导致部分数据丢失

**预防措施**：
- 确保 PostgreSQL 增量日志保留 7 天以上
- 监控 OMS 任务状态，配置告警
- 大表采用旁路导入 + 分段迁移
- 准备完整的回滚方案

### 6.2 性能影响

**风险点**：
- 迁移期间源端数据库性能下降
- 目标端写入压力过大
- 网络带宽耗尽

**预防措施**：
- 选择业务低峰期进行迁移
- 限制迁移并发数
- 监控源端和目标端资源使用
- 在目标端开启写入限流

### 6.3 回滚方案

**回滚准备**：
1. 保持 PostgreSQL 原实例运行
2. 在 PostgreSQL 端保留增量日志
3. 准备应用连接配置的快速切换脚本

**回滚步骤**：
```bash
# 停止应用
systemctl stop your_app

# 更新配置回 PostgreSQL
# ...

# 启动应用
systemctl start your_app

# 验证应用
curl http://localhost:8080/health
```

### 6.4 其他注意事项

**字符集问题**：
- 确保源端和目标端字符集兼容
- PostgreSQL UTF-8 → OceanBase UTF-8 或 UTF-16

**时钟同步**：
- 确保所有节点时钟同步
- 时钟不同步会导致延迟时间不准确

**精度截断**：
- 检查 DECIMAL、FLOAT、DOUBLE 类型精度
- 目标端字段精度应 ≥ 源端精度

**唯一约束 NULL 值**：
- OceanBase Oracle 租户中，唯一约束列多个 NULL 值会冲突
- 需评估业务是否受影响

**OMS 任务释放**：
- 非活跃任务超过 3 天会被自动释放
- 需及时处理异常任务

---

## 七、常见问题（FAQ）

### Q1: OMS 不支持迁移的对象如何处理？

**A**: OMS 不支持迁移以下对象，需手动处理：
- 存储过程
- 函数
- 序列
- 触发器

处理方法：
```bash
# 使用 obdumper 导出
obdumper -h postgres_host -p 5432 -U user -D database \
  --procedure '*' --function '*' --sequence '*' \
  --ddl -f /backup/objects

# 使用 obloader 导入
obloader -h oceanbase_host -P 2881 -u user@tenant#cluster \
  -D database --procedure '*' --function '*' --sequence '*' \
  --ddl -f /backup/objects --thread 8
```

### Q2: 增量同步延迟很高怎么办？

**A**: 可能的原因和解决方案：
1. **网络带宽不足**：增加网络带宽或限制并发数
2. **源端写压力过大**：优化源端应用或迁移时机
3. **目标端性能瓶颈**：优化 OceanBase 参数，增加资源
4. **大表事务**：拆分大事务，减少单次事务量

### Q3: 如何验证迁移后的数据一致性？

**A**: 推荐的验证方法：
1. **记录数对比**：逐表对比 COUNT(*)
2. **抽样对比**：对比前 N 条记录的 MD5 值
3. **汇总值对比**：对比 SUM、AVG 等聚合函数
4. **业务数据校验**：通过业务逻辑验证关键数据

```sql
-- 生成记录数对比报告
SELECT 
    'PostgreSQL' as source, COUNT(*) as count
FROM postgres_db.your_table
UNION ALL
SELECT 
    'OceanBase' as source, COUNT(*) as count
FROM oceanbase.your_table;
```

### Q4: 迁移失败后如何重试？

**A**: 根据失败场景选择策略：
1. **部分表失败**：排除失败表，重试其他表
2. **全量迁移中断**：从断点继续（OMS 支持）
3. **增量同步中断**：重新配置增量同步任务
4. **结构迁移失败**：手动调整表结构后重试

### Q5: OceanBase Oracle 租户的表名大小写问题？

**A**: 
- OceanBase Oracle 租户会自动将表名、字段名转为大写
- 查询时可使用小写、大写或双引号包裹大写
- 不能使用双引号包裹小写

```sql
-- 以下方式都可以
SELECT * FROM table_name;
SELECT * FROM TABLE_NAME;
SELECT * FROM "TABLE_NAME";

-- 以下方式不支持
SELECT * FROM "table_name";
```

---

## 八、迁移检查清单

### 迁移前
- [ ] PostgreSQL 版本兼容性检查（11.x 或 12.x）
- [ ] wal_level 配置为 logical
- [ ] 数据类型映射分析完成
- [ ] 不支持的表类型识别和处理
- [ ] 迁移用户创建和授权完成
- [ ] OceanBase 存储空间充足
- [ ] 迁移方案评审通过
- [ ] 回滚方案准备就绪
- [ ] 相关方通知到位

### 迁移中
- [ ] OMS 任务创建成功
- [ ] 预检查全部通过
- [ ] 结构迁移完成
- [ ] 全量迁移进度正常
- [ ] 增量同步启动成功
- [ ] 监控告警配置完成
- [ ] 性能指标正常

### 验证阶段
- [ ] 记录数一致性校验通过
- [ ] 抽样数据校验通过
- [ ] 应用功能测试通过
- [ ] 性能测试通过
- [ ] 增量同步延迟 < 1秒

### 切换阶段
- [ ] 切换时间窗口确认
- [ ] 应用配置已更新
- [ ] 增量同步已追平
- [ ] 业务切换完成
- [ ] 运行状态正常

### 收尾阶段
- [ ] 持续监控 24 小时
- [ ] 性能优化调整
- [ ] 文档更新完成
- [ ] PostgreSQL 资源释放计划
- [ ] 总结和复盘

---

## 九、参考资源

### 官方文档
- [迁移 RDS PostgreSQL 实例的数据至 OceanBase 数据库 Oracle 租户](https://help.aliyun.com/document_detail/2567977.html)
- [数据迁移流程](https://help.aliyun.com/document_detail/212896.html)
- [同步 DDL 的支持范围和使用限制](https://help.aliyun.com/document_detail/477925.html)

### 技术博客
- [OceanBase数据库大版本迁移升级实践总结](https://www.cnblogs.com/coygfly/p/18692512.html)
- [Oracle 到OceanBase 数据迁移OMS最佳实践](https://developer.aliyun.com/article/1488741)

### 社区资源
- [OceanBase 官方文档](https://www.oceanbase.com/docs)
- [OceanBase 开发者社区](https://developer.aliyun.com/group/oceanbase)

---

## 十、附录：迁移配置模板

### OMS 任务配置示例

```json
{
  "task_name": "pg_to_ob_migration",
  "source": {
    "type": "RDS_POSTGRESQL",
    "instance_id": "rm-xxxxx",
    "database": "your_database",
    "username": "migration_user",
    "password": "********",
    "wal_level": "logical"
  },
  "target": {
    "type": "OCEANBASE",
    "tenant_type": "ORACLE",
    "cluster_address": "ob.example.com:2881",
    "tenant": "your_tenant",
    "database": "your_database",
    "username": "migration_user",
    "password": "********"
  },
  "migration_type": ["STRUCTURE", "FULL", "INCREMENTAL"],
  "object_selection": {
    "mode": "SPECIFIED",
    "tables": ["table1", "table2", "table3"]
  },
  "performance": {
    "threads": 64,
    "batch_size": 2400,
    "connections": 200
  }
}
```

### PostgreSQL 配置模板

```bash
# postgresql.conf
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
```

### OceanBase 连接字符串模板

```bash
# Oracle 租户
obclient -h host -P 2881 -u user@tenant#cluster -p password -D database

# MySQL 租户
obclient -h host -P 2881 -u user@tenant -p password -D database
```

---

**文档版本**：v1.0  
**更新日期**：2025-01-12  
**适用范围**：PostgreSQL 11.x/12.x → OceanBase Oracle 租户

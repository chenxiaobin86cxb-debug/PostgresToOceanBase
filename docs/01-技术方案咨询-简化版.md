# PostgreSQL 到 OceanBase 迁移技术方案（简化版）

## 前提条件

本方案基于以下约束条件制定：
1. **忽略特殊类型处理**：JSON/JSONB 类型和数组类型字段在迁移时将被忽略
2. **OceanBase 使用 MySQL 租户模式**
3. **迁移策略**：全量迁移 + 停机迁移
4. **迁移模式**：使用自定义脚本或工具，不依赖 OMS 数据传输服务

---

## 一、迁移前准备工作

### 1.1 环境评估

#### 源端 PostgreSQL 环境检查
- **版本检查**：支持 PostgreSQL 11.x 及以上版本
- **数据库大小检查**：
  ```sql
  SELECT pg_size_pretty(pg_database_size('your_database'));
  ```

#### 数据库兼容性评估
- 检查是否使用以下不支持的特性：
  - 视图（Views）
  - 分区表（Partitioned Tables）
  - Unlogged 表
  - 临时表（Temporary Tables）

#### 数据量评估
- 统计数据库总大小
- 识别大表（超过 1 亿行或 10GB）
- 评估预计迁移时间（参考：每秒约 1-5 万条记录）

### 1.2 数据类型映射分析

#### PostgreSQL 到 OceanBase MySQL 租户类型映射

| PostgreSQL 类型 | OceanBase MySQL 类型 | 注意事项 |
|----------------|---------------------|----------|
| SMALLINT | SMALLINT | 2字节整数 |
| INTEGER | INT | 4字节整数 |
| BIGINT | BIGINT | 8字节整数 |
| NUMERIC(p,s) | DECIMAL(p,s) | 需保持精度一致 |
| REAL | FLOAT | 单精度浮点 |
| DOUBLE PRECISION | DOUBLE | 双精度浮点 |
| TEXT | TEXT | 大文本数据 |
| VARCHAR(n) | VARCHAR(n) | 字符串类型 |
| CHAR(n) | CHAR(n) | 定长字符串 |
| BYTEA | VARBINARY/BLOB | 二进制数据 |
| DATE | DATE | 日期类型 |
| TIMESTAMP | TIMESTAMP | 时间戳 |
| TIMESTAMPTZ | TIMESTAMP | 时间戳（不保留时区）|
| BOOLEAN | TINYINT(1) | 0=FALSE, 1=TRUE |
| JSON/JSONB | 忽略 | 不迁移 |
| ARRAY | 忽略 | 不迁移 |
| UUID | VARCHAR(36) | UUID 存储 |
| ENUM | VARCHAR(n) | 枚举类型 |

**注意事项**：
- JSON/JSONB 类型和数组类型字段在表结构迁移时将被自动忽略
- TIMESTAMP WITH TIME ZONE 会转换为 TIMESTAMP，时区信息会丢失
- 布尔类型会转换为 TINYINT(1)，应用代码需要适配

### 1.3 表名和字段名规范

**命名规范要求**：
- 仅支持 ASCII 码字符
- 不允许包含特殊字符：换行、空格、.|"'`()=;/&\\
- OceanBase MySQL 租户默认小写敏感（lower_case_table_names = 1）

### 1.4 权限准备

#### PostgreSQL 源端用户权限
```sql
-- 创建迁移专用用户
CREATE USER migration_user WITH PASSWORD 'password';

-- 授予必要权限
GRANT CONNECT ON DATABASE your_database TO migration_user;
GRANT USAGE ON SCHEMA public TO migration_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO migration_user;
```

#### OceanBase MySQL 租户目标端用户权限
```sql
-- 创建迁移专用用户
CREATE USER 'migration_user'@'%' IDENTIFIED BY 'password';

-- 授予必要权限
GRANT ALL PRIVILEGES ON your_database.* TO 'migration_user'@'%';
FLUSH PRIVILEGES;
```

### 1.5 存储空间评估

**OceanBase 需要额外空间**：
- 数据存储：源端数据量的 1.5-2 倍
- 索引空间：考虑重建索引的临时空间
- 备份空间：预留迁移备份空间

---

## 二、迁移策略选择

### 2.1 全量迁移（本方案采用的策略）

**流程**：
1. 停止应用写入
2. 全量迁移表结构
3. 全量迁移数据
4. 验证数据一致性
5. 切换应用到 OceanBase
6. 启动业务

**优点**：
- 实施简单、风险低
- 无需复杂的增量同步配置
- 数据一致性易于验证

**缺点**：
- 业务中断时间较长
- 需要停机窗口

**适用**：
- 数据量 < 100GB
- 可接受停机时间 2-6 小时
- 对数据一致性要求极高

### 2.2 迁移模式选择

#### 自定义脚本开发（本方案采用的模式）
**优点**：
- 完全可控，可定制化
- 不依赖云服务
- 成本低
- 可灵活处理特殊字段（忽略 JSON/JSONB 和数组类型）

**缺点**：
- 需要开发工作
- 需要处理各种边界情况
- 维护成本较高

#### pg_dump + obloader 工具
**适用场景**：
- 小到中等规模数据库（< 50GB）
- 需要快速迁移

**优点**：
- 工具成熟，稳定
- 操作相对简单

**缺点**：
- 不支持过滤特殊字段
- 需要手动处理类型映射

---

## 三、迁移工具推荐

### 3.1 工具对比

| 工具 | 用途 | 优点 | 缺点 |
|------|------|------|------|
| **自定义脚本** | 全量迁移 | 完全可控、可定制 | 需要开发 |
| **pg_dump + obloader** | 简单迁移 | 工具成熟、操作简单 | 不支持过滤字段 |
| **自定义 ETL 工具** | 复杂场景 | 灵活、可扩展 | 开发成本高 |

**本方案推荐**：使用自定义 Python 脚本实现

### 3.2 自定义迁移脚本设计

#### 核心功能
1. **表结构迁移**
   - 自动转换 PostgreSQL 类型到 OceanBase MySQL 类型
   - 自动过滤 JSON/JSONB 和数组类型字段
   - 生成标准的 CREATE TABLE SQL

2. **数据迁移**
   - 批量读取和写入
   - 支持断点续传
   - 实时进度显示

3. **数据验证**
   - 记录数校验
   - 抽样数据对比
   - 汇总值验证

#### 技术栈
- Python 3.8+
- psycopg2：PostgreSQL 驱动
- pymysql：OceanBase MySQL 驱动
- tqdm：进度显示
- loguru：日志记录

### 3.3 pg_dump + obloader 快速迁移（小数据量）

#### PostgreSQL 数据导出
```bash
# 导出整个数据库
pg_dump -h postgres_host -p 5432 -U migration_user \
  -d your_database -f /backup/database.sql

# 仅导出数据
pg_dump -h postgres_host -p 5432 -U migration_user \
  -d your_database -a -f /backup/data.sql
```

#### OceanBase 数据导入
```bash
# 导入 SQL 文件
obloader -h oceanbase_host -P 2881 \
  -u migration_user@tenant -p password \
  -D your_database --file /backup/database.sql \
  --thread 4

# 注意：需要手动修改 SQL 中的类型定义，过滤特殊字段
```

---

## 四、迁移步骤详解

### 4.1 完整迁移流程图

```
准备阶段
├── 1. 环境评估和检查
├── 2. 数据类型映射分析
├── 3. 创建迁移用户
└── 4. 备份源端数据
    ↓
迁移阶段
├── 5. 停止应用写入
├── 6. 执行表结构迁移（过滤特殊字段）
├── 7. 执行全量数据迁移
└── 8. 清理临时数据
    ↓
验证阶段
├── 9. 数据一致性校验
├── 10. 应用功能测试
└── 11. 性能测试
    ↓
切换阶段
├── 12. 切换应用到 OceanBase
├── 13. 验证业务正常运行
└── 14. 监控运行状态
    ↓
收尾阶段
├── 15. 持续监控 24 小时
└── 16. 清理源端资源
```

### 4.2 详细操作步骤

#### 步骤1：环境评估和检查

**PostgreSQL 端**：
```sql
-- 检查版本
SELECT version();

-- 检查数据库大小
SELECT pg_size_pretty(pg_database_size('your_database'));

-- 检查表大小
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 检查不支持的表类型
SELECT tablename FROM pg_tables
WHERE tablename IN (
    SELECT inhrelid::regclass
    FROM pg_inherits
    WHERE inhparent = ANY(
        SELECT oid FROM pg_class WHERE relkind = 'r'
    )
); -- 分区表

-- 检查视图
SELECT schemaname, viewname FROM pg_views;

-- 检查特殊字段类型（JSON/JSONB/数组）
SELECT
    table_name,
    column_name,
    data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND (data_type IN ('json', 'jsonb')
       OR data_type LIKE '%array%'
       OR udt_name LIKE '%array%');
```

**OceanBase 端**：
```sql
-- 检查租户容量
SHOW VARIABLES LIKE 'tenant%';

-- 检查存储空间
SELECT * FROM oceanbase.DBA_OB_TABLEGROUPS;
```

#### 步骤2：数据类型映射分析

生成类型映射报告：
```sql
-- PostgreSQL 端执行，生成类型映射报告
SELECT
    table_name,
    column_name,
    data_type,
    character_maximum_length,
    numeric_precision,
    numeric_scale,
    udt_name
FROM information_schema.columns
WHERE table_schema = 'public'
  AND data_type NOT IN ('json', 'jsonb')
  AND data_type NOT LIKE '%array%'
  AND udt_name NOT LIKE '%array%'
ORDER BY table_name, ordinal_position;
```

#### 步骤3：创建迁移用户

已在 1.4 中详细说明。

#### 步骤4：备份源端数据

```bash
# 使用 pg_dump 备份
pg_dump -h postgres_host -p 5432 -U postgres \
  -d your_database -F c -f /backup/backup_$(date +%Y%m%d_%H%M%S).dump

# 验证备份文件
pg_restore -l /backup/backup_20240112_100000.dump
```

#### 步骤5：停止应用写入

```bash
# 停止应用服务
systemctl stop your_app

# 验证已停止
ps aux | grep your_app

# 检查 PostgreSQL 是否还有写入
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';
```

#### 步骤6-8：执行迁移

使用自定义脚本或工具执行表结构和数据迁移，详细步骤参考"03-自动化脚本实现.md"。

#### 步骤9：数据一致性校验

**记录数校验**：
```sql
-- PostgreSQL
SELECT COUNT(*) FROM your_table;

-- OceanBase
SELECT COUNT(*) FROM your_table;
```

**抽样校验**：
```sql
-- 对比前 1000 条记录
-- PostgreSQL
SELECT * FROM your_table ORDER BY id LIMIT 1000;

-- OceanBase
SELECT * FROM your_table ORDER BY id LIMIT 1000;
```

**汇总值对比**：
```sql
-- 对比数值字段总和
SELECT SUM(amount) FROM your_table;
```

#### 步骤10-11：应用测试

在测试环境中验证应用功能：
```bash
# 启动测试应用
python -m pytest tests/

# 性能测试
ab -n 1000 -c 10 http://your_app/api/test
```

#### 步骤12：切换应用到 OceanBase

**切换检查清单**：
- [ ] 数据一致性校验通过
- [ ] 应用功能测试通过
- [ ] 应用连接配置已更新
- [ ] 回滚方案已准备
- [ ] 通知相关方

**切换命令示例**：
```bash
# 停止应用
systemctl stop your_app

# 更新应用配置（指向 OceanBase）
# 修改配置文件：config/database.yaml

# 启动应用
systemctl start your_app

# 验证应用
curl http://localhost:8080/health
```

---

## 五、性能优化建议

### 5.1 批量操作优化

```yaml
# 自定义脚本配置
migration:
  data:
    batch_size: 1000      # 批量插入大小
    chunk_size: 10000     # 每次读取的记录数
    parallel_workers: 4    # 并发工作数
```

### 5.2 OceanBase MySQL 租户参数优化

```sql
-- 批量插入优化
SET GLOBAL max_allowed_packet = 64*1024*1024;  -- 64MB
SET GLOBAL innodb_buffer_pool_size = 2*1024*1024*1024;  -- 2GB

-- 写入优化
SET GLOBAL innodb_flush_log_at_trx_commit = 2;
SET GLOBAL sync_binlog = 0;

-- 连接数优化
SET GLOBAL max_connections = 500;
```

### 5.3 大表迁移优化

**分表迁移**：
- 将大表拆分为多个小批次
- 使用游标分批读取
- 避免内存溢出

**索引优化**：
```sql
-- 全量迁移前删除二级索引
ALTER TABLE large_table DROP INDEX idx_name;

-- 全量迁移完成后重建索引
CREATE INDEX idx_name ON large_table(column_name);
```

---

## 六、风险和注意事项

### 6.1 数据丢失风险

**风险点**：
- 迁移过程中断导致部分数据丢失
- 特殊字段被忽略导致数据不完整

**预防措施**：
- 迁移前完整备份源数据库
- 启用断点续传功能
- 保留源数据库至少 7 天
- 详细记录被忽略的特殊字段

### 6.2 特殊字段处理

**JSON/JSONB 字段**：
- 会被完全忽略，不进行迁移
- 迁移后需应用层重新处理
- 建议评估业务依赖程度

**数组字段**：
- 会被完全忽略，不进行迁移
- 如必须保留，需改造表结构
- 考虑拆分为多个关联表

**其他字段**：
- TIMESTAMP WITH TIME ZONE：时区信息会丢失
- BOOLEAN：需适配为 TINYINT(1)

### 6.3 回滚方案

**回滚准备**：
1. 保持 PostgreSQL 原实例运行
2. 完整备份 PostgreSQL 数据库
3. 准备应用连接配置的快速切换脚本

**回滚步骤**：
```bash
# 停止应用
systemctl stop your_app

# 更新配置回 PostgreSQL
# 修改配置文件：config/database.yaml

# 启动应用
systemctl start your_app

# 验证应用
curl http://localhost:8080/health
```

### 6.4 其他注意事项

**字符集问题**：
- 确保源端和目标端字符集兼容（UTF-8）
- 检查是否有特殊字符

**精度截断**：
- 检查 DECIMAL、FLOAT、DOUBLE 类型精度
- 目标端字段精度应 ≥ 源端精度

**时钟同步**：
- 确保所有节点时钟同步

---

## 七、常见问题（FAQ）

### Q1: JSON/JSONB 字段如何处理？

**A**: 根据本方案的前提条件，JSON/JSONB 字段将被忽略，不进行迁移。

如果业务必须保留，有以下替代方案：
1. 改造表结构，将 JSON 字段拆分为多个普通字段
2. 使用应用层处理，在迁移后手动补充数据
3. 重新评估是否需要迁移这些数据

### Q2: 数组字段如何处理？

**A**: 根据本方案的前提条件，数组字段将被忽略，不进行迁移。

如果业务必须保留，有以下替代方案：
1. 拆分为多个字段（适用于定长小数组）
2. 拆分为关联表（适用于变长数组）
3. 转换为 JSON 字符串存储（需要应用层解析）

### Q3: 如何验证迁移后的数据一致性？

**A**: 推荐的验证方法：
1. **记录数对比**：逐表对比 COUNT(*)
2. **抽样对比**：对比前 N 条记录的 MD5 值
3. **汇总值对比**：对比 SUM、AVG 等聚合函数
4. **业务数据校验**：通过业务逻辑验证关键数据

```sql
-- 生成记录数对比报告
SELECT
    'PostgreSQL' as source, COUNT(*) as count
FROM postgres_db.your_table
UNION ALL
SELECT
    'OceanBase' as source, COUNT(*) as count
FROM oceanbase.your_table;
```

### Q4: 迁移失败后如何重试？

**A**: 根据失败场景选择策略：
1. **部分表失败**：排除失败表，重试其他表
2. **全量迁移中断**：使用断点续传，从断点继续
3. **结构迁移失败**：手动调整表结构后重试
4. **数据迁移失败**：检查网络、权限等，重试失败表

### Q5: OceanBase MySQL 租户的表名大小写问题？

**A**: OceanBase MySQL 租户的 lower_case_table_names 默认为 1，即表名不区分大小写，统一存储为小写。

```sql
-- 以下方式都可以
SELECT * FROM table_name;
SELECT * FROM TABLE_NAME;
```

---

## 八、迁移检查清单

### 迁移前
- [ ] PostgreSQL 版本兼容性检查
- [ ] 数据类型映射分析完成
- [ ] 特殊字段识别（JSON/JSONB、数组）
- [ ] 迁移用户创建和授权完成
- [ ] OceanBase 存储空间充足
- [ ] 源端数据库备份完成
- [ ] 迁移方案评审通过
- [ ] 回滚方案准备就绪
- [ ] 相关方通知到位

### 迁移中
- [ ] 应用写入已停止
- [ ] 表结构迁移完成（特殊字段已过滤）
- [ ] 全量迁移进度正常
- [ ] 监控告警配置完成
- [ ] 性能指标正常

### 验证阶段
- [ ] 记录数一致性校验通过
- [ ] 抽样数据校验通过
- [ ] 应用功能测试通过
- [ ] 性能测试通过

### 切换阶段
- [ ] 切换时间窗口确认
- [ ] 应用配置已更新
- [ ] 业务切换完成
- [ ] 运行状态正常

### 收尾阶段
- [ ] 持续监控 24 小时
- [ ] 性能优化调整
- [ ] 文档更新完成
- [ ] 源端资源保留计划
- [ ] 总结和复盘

---

## 九、参考资源

### 官方文档
- [PostgreSQL 官方文档](https://www.postgresql.org/docs/)
- [OceanBase 官方文档](https://www.oceanbase.com/docs)
- [OceanBase 开源社区](https://github.com/oceanbase/oceanbase)

### 技术博客
- [PostgreSQL 到 MySQL 迁移经验](https://www.percona.com/blog/migrating-postgresql-to-mysql/)
- [OceanBase MySQL 兼容性说明](https://www.oceanbase.com/docs/)

### 学习资源
- [PostgreSQL 中文社区](https://www.postgres.cn/)
- [OceanBase 开发者社区](https://developer.aliyun.com/group/oceanbase)
- [墨天轮数据库社区](https://www.modb.pro/)

---

## 十、附录：迁移配置模板

### 自定义脚本配置示例

```yaml
# config.yaml
source:
  host: localhost
  port: 5432
  database: mydb
  user: migration_user
  password: ${POSTGRES_PASSWORD}
  schema: public

target:
  host: localhost
  port: 2881
  database: mydb
  user: migration_user@tenant
  password: ${OCEANBASE_PASSWORD}
  mode: mysql

migration:
  schema:
    enabled: true
    ignore_types: ['json', 'jsonb', 'array']

  data:
    enabled: true
    batch_size: 1000
    parallel_workers: 4
    chunk_size: 10000

  validation:
    enabled: true
    sample_size: 1000
    check_count: true
```

### PostgreSQL 备份命令模板

```bash
# 完整备份
pg_dump -h host -p 5432 -U postgres \
  -d database -F c -f backup.dump

# 仅数据备份
pg_dump -h host -p 5432 -U postgres \
  -d database -a -f data.sql
```

### OceanBase 连接字符串模板

```bash
# MySQL 租户连接
mysql -h host -P 2881 -u user@tenant -p database

# obclient 连接
obclient -h host -P 2881 -u user@tenant -p password -D database
```

---

**文档版本**：v2.0（简化版）
**更新日期**：2025-01-12
**适用范围**：PostgreSQL → OceanBase MySQL 租户（全量迁移 + 停机迁移）
**约束条件**：忽略 JSON/JSONB 和数组类型字段
